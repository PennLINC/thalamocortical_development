---
title: "Thalamocortical Connectivity Development along the Sensorimotor-Association Axis: Sensitivity Analyses"
author: "Valerie Jill Sydnor"
output: 
  rmdformats::robobook:
    highlight: monochrome
    lightbox: true
    gallery: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(plyr)
library(dplyr)
library(tidyverse)
library(cifti)
library(ggplot2)
library(ggseg)
library(ggsegGlasser)
library(scales)
library(PupillometryR)
library(Hmisc)
library(matrixStats)
library(ggnewscale)
library(cocor)
library(reshape2)
library(EnvStats)
extrafont::loadfonts()
library(mgcv)
source("/cbica/projects/thalamocortical_development/code/thalamocortical_development/rotate_parcellation/R/perm.sphere.p.R")
```

# Read in Data for Developmental Characterization 

Glasser parcel names

```{r, warning = F, message = F}
#Glasser regions with corresponding labels and tract names
glasser.regions <- read.csv("/cbica/projects/thalamocortical_development/Maps/parcellations/surface/glasser360_regionlist.csv")
glasser.regions$tract <- paste0("thalamus_", glasser.regions$orig_parcelname) %>% gsub("_ROI", "_autotrack", .) %>% gsub("-", "_", .) 
```

S-A axis

```{r, warning = F, message = F}
S.A.axis.cifti <- read_cifti("/cbica/projects/thalamocortical_development//Maps/S-A_ArchetypalAxis/FSLRVertex/SensorimotorAssociation_Axis_parcellated/SensorimotorAssociation.Axis.Glasser360.pscalar.nii") #S-A_ArchetypalAxis repo
S.A.axis <- data.frame(SA.axis = rank(S.A.axis.cifti$data), orig_parcelname = names(S.A.axis.cifti$Parcel))
S.A.axis <- merge(S.A.axis, glasser.regions, by = c("orig_parcelname"), sort = F)
```

Spatial permutation (spin) test parcel rotation matrix

```{r}
perm.id.full <- readRDS("/cbica/projects/thalamocortical_development/software/rotate_parcellation/glasser_sphericalrotations_N10000.rds") #10,000 spatial null spins
spin.parcels <- glasser.regions
```

Dataset-specific tract lists

```{r}
#generated by tract_measures/tractlists/thalamocortical_tractlists.R
tractlist.pnc <- read.csv("/cbica/projects/thalamocortical_development/thalamocortical_structuralconnectivity/individual/PNC/PNC_tractlist_primary.csv") 
tractlist.hcpd <- read.csv("/cbica/projects/thalamocortical_development/thalamocortical_structuralconnectivity/individual/HCPD/HCPD_tractlist_primary.csv") 
```

Sensitivity variable dfs

```{r}
#Surface area
area.glasser.pnc <- read.csv("/cbica/projects/thalamocortical_development/cortical_anatomy/individual/PNC/PNC_surfacearea_finalsample.csv")
area.glasser.hcpd <- read.csv("/cbica/projects/thalamocortical_development/cortical_anatomy/individual/HCPD/HCPD_surfacearea_finalsample.csv")

#SNR 
snr.glasser.pnc <- read.csv("/cbica/projects/thalamocortical_development/thalamocortical_structuralconnectivity/individual/PNC/PNC_SNR_finalsample.csv")
snr.glasser.hcpd <- read.csv("/cbica/projects/thalamocortical_development/thalamocortical_structuralconnectivity/individual/HCPD/HCPD_SNR_finalsample.csv") 

#Overlap sensitivity
sensitivity.glasser.pnc <- read.csv("/cbica/projects/thalamocortical_development/thalamocortical_structuralconnectivity/individual/PNC/PNC_overlapsensitivity_finalsample.csv")
sensitivity.glasser.hcpd <- read.csv("/cbica/projects/thalamocortical_development/thalamocortical_structuralconnectivity/individual/HCPD/HCPD_overlapsensitivity_finalsample.csv")
```

Sensitivity analysis results

```{r, message=F, warning=F}
setwd("/cbica/projects/thalamocortical_development/thalamocortical_results/sensitivity_results/") #gam output dir, from gam_functions/fit_sensitivityGams.R

#list all .csv files in the environment results directory
files <- list.files(getwd(), pattern = '.csv', ignore.case = T, full.names = F) 

for(i in 1:length(files)){
  filename <- files[i]
  Rname <- gsub('^.{12}|.{4}$', '', filename)
  x <- read.csv(filename, header = TRUE)
  assign(Rname, x) 
}
rm(x)
```

# Association Between Tract-wise Sensitivity Variables and Main Analysis Maturational Timing  

Main analysis thalamocortical development results 

```{r}
gameffects_FA_glasser_pnc <- read.csv("/cbica/projects/thalamocortical_development/thalamocortical_results/development_results/development_gameffects_FA_glasser_pnc.csv")

gameffects_FA_glasser_hcpd <- read.csv("/cbica/projects/thalamocortical_development/thalamocortical_results/development_results/development_gameffects_FA_glasser_pnc.csv")
```

Sensitivity variables in thalamocortical connections

```{r}
tract_average_measures <- function(input.df, average.measure, final.tractlist){
  input.df <- input.df %>% select(contains("autotrack")) #ensure we only have tract columns 
  tract.averages <- colMeans(input.df, na.rm = TRUE) %>% as.data.frame %>% set_names(sprintf("mean_%s", average.measure)) %>% mutate(tract = row.names(.))
  tract.averages <- tract.averages[tract.averages$tract %in% final.tractlist$tract,]
  tract.averages <- merge(tract.averages, S.A.axis, by = "tract", sort = F)
  return(tract.averages)
}
```

```{r}
#surface area
regional.area.pnc <- tract_average_measures(input.df = area.glasser.pnc, average.measure = "area", final.tractlist = tractlist.pnc)
regional.area.hcpd <- tract_average_measures(input.df = area.glasser.hcpd, average.measure = "area", final.tractlist = tractlist.hcpd)

#connection SNR
tract.snr.pnc <- tract_average_measures(input.df = snr.glasser.pnc, average.measure = "SNR", final.tractlist = tractlist.pnc)
tract.snr.hcpd <- tract_average_measures(input.df = snr.glasser.hcpd, average.measure = "SNR", final.tractlist = tractlist.hcpd)

#atlas overlap sensitivity
tract.overlap.pnc <- tract_average_measures(input.df = sensitivity.glasser.pnc, average.measure = "sensitivity", final.tractlist = tractlist.pnc)
tract.overlap.hcpd <- tract_average_measures(input.df = sensitivity.glasser.hcpd, average.measure = "sensitivity", final.tractlist = tractlist.hcpd)
```

```{r}
#Combine development results and sensitivity measures
df.list.pnc <- list(gameffects_FA_glasser_pnc, regional.area.pnc, tract.snr.pnc, tract.overlap.pnc) #dfs to merge
gameffects_FA_glasser_pnc <- Reduce(function(x,y) merge(x,y, all=TRUE, sort=F), df.list.pnc) 
gameffects_FA_glasser_pnc <- left_join(spin.parcels, gameffects_FA_glasser_pnc, by = join_by(orig_parcelname, label, tract))

df.list.hcpd <- list(gameffects_FA_glasser_hcpd, regional.area.hcpd, tract.snr.hcpd, tract.overlap.hcpd) #dfs to merge
gameffects_FA_glasser_hcpd <- Reduce(function(x,y) merge(x,y, all=TRUE, sort=F), df.list.hcpd) 
gameffects_FA_glasser_hcpd <- left_join(spin.parcels, gameffects_FA_glasser_hcpd, by = join_by(orig_parcelname, label, tract))
```

## Associations

### surface area

```{r, warning = F}
cor.test(gameffects_FA_glasser_pnc$smooth.increase.offset, gameffects_FA_glasser_pnc$mean_area, method = c("spearman"))

perm.sphere.p(x = gameffects_FA_glasser_pnc$smooth.increase.offset, y = gameffects_FA_glasser_pnc$mean_area, perm.id = perm.id.full, corr.type = "spearman")
```

```{r, warning = F}
cor.test(gameffects_FA_glasser_hcpd$smooth.increase.offset, gameffects_FA_glasser_hcpd$mean_area, method = c("spearman"))

perm.sphere.p(x = gameffects_FA_glasser_hcpd$smooth.increase.offset, y = gameffects_FA_glasser_hcpd$mean_area, perm.id = perm.id.full, corr.type = "spearman")
```

### connection SNR

```{r, warning = F}
cor.test(gameffects_FA_glasser_pnc$smooth.increase.offset, gameffects_FA_glasser_pnc$mean_SNR, method = c("spearman"))

perm.sphere.p(x = gameffects_FA_glasser_pnc$smooth.increase.offset, y = gameffects_FA_glasser_pnc$mean_SNR, perm.id = perm.id.full, corr.type = "spearman")
```

```{r, warning = F}
cor.test(gameffects_FA_glasser_hcpd$smooth.increase.offset, gameffects_FA_glasser_hcpd$mean_SNR, method = c("spearman"))

perm.sphere.p(x = gameffects_FA_glasser_hcpd$smooth.increase.offset, y = gameffects_FA_glasser_hcpd$mean_SNR, perm.id = perm.id.full, corr.type = "spearman")
```

### atlas overlap sensitivity

```{r, warning = F}
cor.test(gameffects_FA_glasser_pnc$smooth.increase.offset, gameffects_FA_glasser_pnc$mean_sensitivity, method = c("spearman"))

perm.sphere.p(x = gameffects_FA_glasser_pnc$smooth.increase.offset, y = gameffects_FA_glasser_pnc$mean_sensitivity, perm.id = perm.id.full, corr.type = "spearman")
```

```{r, warning = F}
cor.test(gameffects_FA_glasser_hcpd$smooth.increase.offset, gameffects_FA_glasser_hcpd$mean_sensitivity, method = c("spearman"))

perm.sphere.p(x = gameffects_FA_glasser_hcpd$smooth.increase.offset, y = gameffects_FA_glasser_hcpd$mean_sensitivity, perm.id = perm.id.full, corr.type = "spearman")
```

# Developmental Sensitivity Analyses

## Number of significant developmental effects

Function to calculate FDR-corrected significant age effects

```{r}
sig.effects <- function(dataset, sensitivity_measure){
 
   ageeffects.df <- get(sprintf("gameffects_FA_%s_%s", sensitivity_measure, dataset)) 
  ageeffects.df$significant <- p.adjust(ageeffects.df$Anova.smooth.pvalue, method = c("fdr")) < 0.05 
  
  sigeffect.totaln <- sum(ageeffects.df$significant) 
  sigeffect.percent <- round(sigeffect.totaln/length(ageeffects.df$significant)*100, 2) 
  
  print(sprintf("In %s, %s thalamocortical connections (%s percent) show significant age-related changes when controlling for %s", dataset, sigeffect.totaln, sigeffect.percent, sensitivity_measure))
}
```

### Sensitivity analysis: surface area

```{r}
sig.effects(dataset = "pnc", sensitivity_measure = "area")
```

```{r}
sig.effects(dataset = "hcpd", sensitivity_measure = "area")
```

### Sensitivity analysis: connection SNR

```{r}
sig.effects(dataset = "pnc", sensitivity_measure = "SNR")
```

```{r}
sig.effects(dataset = "hcpd", sensitivity_measure = "SNR")
```

### Sensitivity analysis: atlas overlap sensitivity (true positives)

```{r}
sig.effects(dataset = "pnc", sensitivity_measure = "sensitivity")
```

```{r}
sig.effects(dataset = "hcpd", sensitivity_measure = "sensitivity")
```

## Cortex-wide thalamic connectivity developmental profiles

Function to plot tract-wise GAM smooths

```{r}
developmental.smooths <- function(dataset, sensitivity_measure){
 
  #get data for plotting 
  ageeffects.df <- get(sprintf("gameffects_FA_%s_%s", sensitivity_measure, dataset)) 
  smooths.df <- get(sprintf("smoothcentered_FA_%s_%s", sensitivity_measure, dataset)) 
  
  smooths.df <- merge((smooths.df %>% filter(grepl("thalamus_R", tract))), (ageeffects.df %>% select(tract, GAM.smooth.partialR2)), by = "tract")
  
  #match plotting params used in the main manuscript figures
  if(dataset == "pnc"){
    limit.low = 0
    limit.high = 0.1
  }
  if(dataset == "hcpd"){
    limit.low = -0.02
    limit.high = 0.075
  }
  
  #plot tract-wise developmental trajectories
  smooths.plot <- ggplot(smooths.df, aes(x = age, y = est, group = tract, color = GAM.smooth.partialR2)) +
    geom_line(linewidth = .3, alpha = .8) + 
    scale_color_gradientn(colors = c("#FEC22F", "#F59A72", "#9c3a80", "#672975","#323280"), limits = c(limit.low, limit.high), oob = squish) +
    theme_minimal() +
    labs(x="\nAge", y="Connection FA\n") +
    scale_x_continuous(breaks=c(8, 10, 12, 14, 16, 18, 20, 22), expand = c(0,.45)) +
    theme(
    legend.position = "none", 
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.text = element_text(size = 5, family = "Arial", color = c("black")),
    axis.title.x = element_text(size = 5, family ="Arial", color = c("black")),
    axis.title.y = element_text(size = 5, family ="Arial", color = c("black")),
    axis.line = element_line(linewidth = .2), 
    axis.ticks = element_line(linewidth = .2))
  
  ggsave(filename = sprintf("/cbica/projects/thalamocortical_development/figures/images/Figure_sensitivity_supplement/agesmooths_%s_%s.pdf", sensitivity_measure, dataset), device = "pdf", dpi = 500, width = 1.85, height = 1.65)

  return(smooths.plot)
}
```

### Sensitivity analysis: surface area

```{r}
developmental.smooths(dataset = "pnc", sensitivity_measure = "area")
```

```{r}
developmental.smooths(dataset = "hcpd", sensitivity_measure = "area")
```

### Sensitivity analysis: connection SNR

```{r}
developmental.smooths(dataset = "pnc", sensitivity_measure = "SNR")
```

```{r}
developmental.smooths(dataset = "hcpd", sensitivity_measure = "SNR")
```

### Sensitivity analysis: atlas overlap sensitivity (true positives)

```{r}
developmental.smooths(dataset = "pnc", sensitivity_measure = "sensitivity")
```

```{r}
developmental.smooths(dataset = "hcpd", sensitivity_measure = "sensitivity")
```

## Thalamocortical Connectivity Maturation is Organized by the Sensorimotor-Association Axis

Function to compute age of maturation correlation with the S-A axis and its spin-based significance

```{r}
SA.alignment.statistics <- function(dataset, sensitivity_measure){
 
   ageeffects.df <- get(sprintf("gameffects_FA_%s_%s", sensitivity_measure, dataset)) 
   ageeffects.df <- merge(ageeffects.df, (S.A.axis %>% select(tract, SA.axis)), by = "tract", sort = F)
   
   spin.data <- left_join(spin.parcels, ageeffects.df, by = c("tract")) 
   corr.value <- cor.test(spin.data$SA.axis, spin.data$smooth.increase.offset, method = c("spearman"), exact = F)$estimate
   pspin.value <- perm.sphere.p(x = spin.data$SA.axis, y = spin.data$smooth.increase.offset, perm.id = perm.id.full, corr.type = "spearman")
   
   results <- cbind(corr.value, pspin.value)

  return(results)
}
```

Function to plot thalamocortical connection age of maturation along the S-A axis

```{r}
SA.alignment.plot <- function(dataset, sensitivity_measure){
 
   ageeffects.df <- get(sprintf("gameffects_FA_%s_%s", sensitivity_measure, dataset)) 
   ageeffects.df <- merge(ageeffects.df, (S.A.axis %>% select(tract, SA.axis)), by = "tract", sort = F)

   SA.plot <- ggplot(ageeffects.df, aes(x = SA.axis, y = smooth.increase.offset, color = SA.axis)) +
    geom_point(size = 0.5) +
    geom_smooth(method = "lm", color = c("black"), formula = y ~ x, linewidth = 0.2) + 
    scale_color_gradient2(low = "goldenrod1", mid = "#ede4f5", high = "#6f1282", guide = "colorbar", aesthetics = "color", midpoint = 180) +
    theme_classic() +
    scale_y_continuous(limits = c(12, 23), breaks = c(12, 14, 16, 18, 20, 22)) +
    labs(x="\nS-A axis", y="Age of maturation (years)\n") +
    theme(
    legend.position = "none", 
    axis.text = element_text(size = 5, family = "Arial", color = c("black")),
    axis.title.x = element_text(size = 5, family ="Arial", color = c("black")),
    axis.title.y = element_text(size = 5, family ="Arial", color = c("black")),
    axis.line = element_line(linewidth = .2), 
    axis.ticks = element_line(linewidth = .2)) 

    ggsave(filename = sprintf("/cbica/projects/thalamocortical_development/figures/images/Figure_sensitivity_supplement/SAaxis_alignment_%s_%s.pdf", sensitivity_measure, dataset), device = "pdf", dpi = 500, width = 1.85, height = 1.65)

  return(SA.plot)
}
```

### Sensitivity analysis: surface area

```{r, message = F, warning = F}
SA.alignment.statistics(dataset = "pnc", sensitivity_measure = "area")
SA.alignment.plot(dataset = "pnc", sensitivity_measure = "area")
```

```{r, message = F, warning = F}
SA.alignment.statistics(dataset = "hcpd", sensitivity_measure = "area")
SA.alignment.plot(dataset = "hcpd", sensitivity_measure = "area")
```

### Sensitivity analysis: connection SNR

```{r, message = F, warning = F}
SA.alignment.statistics(dataset = "pnc", sensitivity_measure = "SNR")
SA.alignment.plot(dataset = "pnc", sensitivity_measure = "SNR")
```

```{r, message = F, warning = F}
SA.alignment.statistics(dataset = "hcpd", sensitivity_measure = "SNR")
SA.alignment.plot(dataset = "hcpd", sensitivity_measure = "SNR")
```

### Sensitivity analysis: atlas overlap sensitivity (true positives)

```{r, message = F, warning = F}
SA.alignment.statistics(dataset = "pnc", sensitivity_measure = "sensitivity")
SA.alignment.plot(dataset = "pnc", sensitivity_measure = "sensitivity")
```

```{r, message = F, warning = F}
SA.alignment.statistics(dataset = "hcpd", sensitivity_measure = "sensitivity")
SA.alignment.plot(dataset = "hcpd", sensitivity_measure = "sensitivity")
```

