# A DIFFUSION MRI ATLAS OF REGIONALLY-SPECIFIC THALAMOCORTICAL STRUCTURAL CONNECTIONS
Implementation instructions for applying the **thalamocortical tractography atlas** to new data are provided below! This tracotgraphy atlas can be used with DSI Studio to delineate anatomically-validated structural connections between the left and right thalamus and specific cortical regions defined by the HCP-MMP parcellation [(Glasser et al., 2016)](https://www.nature.com/articles/nature18933). 

## Step 1. Install DSI Studio

DSI Studio can be obtained directly for Mac, Windows, and Ubuntu or installed via container. 

* To download DSI Studio directly for Mac, Windows, or Ubuntu (no installation needed), access the download link for your operating system from the [DSI Studio releases link](https://github.com/frankyeh/DSI-Studio/releases). For proper implementation of automated tractography with the thalamocortical atlas, you must use versions 2023.12.06 "Chen" Release or 2024.05.22 "Chen" Release (2024 "Hou" Releases are in pre-release under testing by Frank Yeh).

* To install DSI Studio via a Docker/singularity container, access DSI Studio's [docker hub repository](https://hub.docker.com/r/dsistudio/dsistudio), which has all DSI Studio releases under "Tags". For proper implementation of automated tractography with the thalamocortical atlas, you must use a **Chen** version created on or after chen-2023-02-27 (Hou versions are in pre-release testing). [chen-2023-02-27](https://hub.docker.com/layers/dsistudio/dsistudio/chen-2023-02-27/images/sha256-96cee3c7ea03a7a8d12d675358832c096b1921ed4a8386884a733a17d99a7aec?context=explore) is the container version used in "A sensorimotor-association axis of thalamocortical connection development". A singularity image can be created with:

```bash
singularity dsistudio-latest.simg docker://dsistudio/dsistudio:latest #for the most recent software version
singularity dsistudio-chen-20230227.simg docker://dsistudio/dsistudio:chen-2023-02-27 #for the specific docker container used in this manuscript
```
## Step 2. Reconstruct your pre-processed diffusion data with GQI to create FIB files for tracking in DSI Studio
DSI Studio uses FIB files (*fib.gz) reconstructed with [generalized q-sampling imaging](https://pubmed.ncbi.nlm.nih.gov/20304721/) (GQI) as input to tractography. GQI models the water diffusion ODF and can be applied to both shelled and non-shelled sampling schemes. FIB files store the vector field (fiber orientations) and anisotropy information (the magnitude) required for streamline tracking. FIB files can be reconstructed with dsi studio directly ([see instructions](https://dsi-studio.labsolver.org/doc/cli_t2.html)) or using QSIRecon's *dsi_studio_gqi* workflow. 

To implement GQI with [QSIRecon](https://qsirecon.readthedocs.io/en/latest/), the software can first be [installed via container](https://qsirecon.readthedocs.io/en/latest/installation.html). Once installed, the built-in reconstruction workflow [dsi_studio_gqi](https://qsirecon.readthedocs.io/en/latest/builtin_workflows.html#dsi-studio-gqi) can be run to generate a *space-T1w*_dwimap.fib.gz file, which is used as input to autotrack with the curated thalamocortical tractography atlas (accessed in Step 3). Note, QSIprep outputs will work as inputs for QSIRecon as-is. 

Example code for running QSIRecon's dsi_studio_gqi workflow via singularity container:

```bash
singularity run \ 
    --containall \
    --writable-tmpfs \
    -B "${PWD}" \ #directory(ies) to bind in the container
    qsirecon-latest.simg \ #singularity container
    "${PWD}/inputs/qsiprep" \ #input to dsi_studio_gqi, generated by qsiprep 
    "${PWD}/results/qsirecon" \ #outputs from dsi_studio_gqi, generated by qsirecon
    participant \ 
    -w "${PWD}/work" \ #work dir
    --nthreads 8 \ #cores
    --omp-nthreads 8 \
    --recon-spec dsi_studio_gqi \ #built-in reconstruction workflow
    -v -v
``` 

[Example fib files for testing can be accessed via DSI Studio](https://brain.labsolver.org/).

## Step 3. Access the thalamocortical tractography atlas
The thalamocortical tractography atlas can be used to delineate atlas-defined thalamic connections in individual participant's data. The manually curated and anatomically-validated atlas consists of two key files, which are provided [on this page](https://github.com/PennLINC/thalamocortical_development/tree/main/results/thalamocortical_autotrack_template). These files include:
1. **ICBM152_adult.tt.gz** : an atlas containing all individual structural connections between the thalamus and HCP-MMP cortical regions
2. **ICBM152_adult.tt.gz.txt** : a list of the connections included in the atlas

To use this custom atlas within DSI Studio, these two files must be accessible within the DSI Studio software in the expected location (and with the expected names)! 

* On a Mac, e.g., this location is `$software_dir/dsi_studio/dsi_studio.app/Contents/MacOs/atlas/ICBM152_adult`. The two atlas files must be copied to this location with the exact names retained. However, do note that DSI Studio provides its own autotrack atlas for major cortical bundles that lives in this location with these same names. If you do not wish to permanently overwrite the original autotrack bundles, consider renaming the original files temporarily while you implement thalamocorical tracotgraphy :) 

* In a container, this location is /opt/dsi-studio/atlas/ICBM152_adult. To use these 2 files with a dsi-studio container, bind a local directory containing BOTH the usual contents of atlas/ICBM152_adult (i.e., those provided with the software) and these thalamus-specific .tt.gz and .tt.gz.txt files to the container directory (e.g., -B /cbica/projects/thalamocortical_development/software/thalamocortical_autotrack_template/dsi-studio/atlas/ICBM152_adult/:/opt/dsi-studio/atlas/ICBM152_adult). Alternatively, bind the individual thalamus-specific .tt.gz and .tt.gz.txt files to the corresponding original files in /opt/dsi-studio/atlas/ICBM152_adult (see example code in Step 4).

## Step 4. Run autotrack with the thalamocortical tractography atlas
The thalamocortical tractography atlas can now be used as an anatomical prior to delineate thalamocortical structural pathways in your data! This process involves using DSI Studio's autotrack, a trajectory-based automated tract recognition approach.  

* To run autotrack via the command-line using a downloaded version of DSI Studio, you can follow the general autotrack instructions provided [here](https://dsi-studio.labsolver.org/doc/cli_atk.html) and use the specific command provided below. To track all possible thalamocortical connections, run the command below specifying --track_id=thalamus. To reconstruct one (or a subset) of connections, you can specify a more specific track_id based on the list of connection names in ICBM152_adult.tt.gz.txt (for example --track_id=thalamus-R_4-autotrack,thalamus-L_V1-autotrack).

```bash
dsi_studio --action=atk --source=$subid.fib.gz --track_id=thalamus --otsu_threshold=0.5 --smoothing=1 --tolerance=10 --tip_iteration=0 --track_voxel_ratio=4 --check_ending=0 --export_stat=1 --export_trk=1 --yield_rate=0.0000001 --export_template_trk=1 --overwrite=1 #these command line arguments are described below
```
* To run autotrack using a DSI Studio container, the following template call can be used:

```bash
singularity exec --cleanenv --containall \ 
    -B ${DATA_DIR} \ #bind data directory with fib.gz files
    -B atlas/ICBM152_adult.tt.gz:/opt/dsi-studio/atlas/ICBM152_adult/ICBM152_adult.tt.gz #bind tractography atlas to file in container
    -B atlas/ICBM152_adult.tt.gz.txt:/opt/dsi-studio/atlas/ICBM152_adult/ICBM152_adult.tt.gz.txt #bind connection list to file in container
    dsistudio-latest.simg \ #dsi studio container 
    dsi_studio \
        --action=atk \ #run autotrack
        --source=${FIB} \ #the source for tracking is the participant's fib file, which must be accessible in the bound $DATA_DIR
	--otsu_threshold=0.5 \ #Otsu's threshold for tracking 
	--smoothing=1 \ #select a random smoothing amount between 0% to 95% for each streamline; smoothing uses previous propagation vector directional information 
	--tolerance=10 \ #Hausdorff distance threhold
	--tip_iteration=0 \ #no topology-informed pruning
	--track_voxel_ratio=4 \ #the track-voxel ratio for the total number of streamline count. Increased from the default of 2 to facilitate better mapping (at the expense of greater computation time)
        --check_ending=0 \  #don't remove tracts that terminate in high anisotropy areas
        --track_id=thalamus \ 
	--export_stat=1 \ #write out connection statistics file
	--export_trk=1 \  #write out the reconstructed connection as a tractography file 
	--yield_rate=0.0000001 \ #yield rate that must be met before fiber tracking is terminated and no output is generated
	--export_template_trk=1 \ #write out reconstructed connection in dsi-studio template space
	--overwrite=1 \ #overwrite existing files
```

Depending on the computing environment and thalamocortical connection, it may take between a few to ~20 minutes to reconstruct a given connection. On a computing cluster with ample resources (e.g. 8-10 cores), all thalamocortical connections can be reconstructed for one scan in approximately 7-10 hours. On a stand-alone desktop computer, it may take up to a few days.
 
Autotrack outputs are written (by default) to the $DATA_DIR where the source .fib.gz file exists. Within this $DATA_DIR, a directory is created for each individual thalamocortical connection that is named thalamus-$hemi_$corticalregion-autotrack; the cortical region names correspond to those in the HCP-MMP parcellation. Three files will exist in each connection's directory:
1. $subid.thalamus-$hemi_$corticalregion-autotrack.tt.gz, the structural connection in subject space
2. T_$subid.thalamus-$hemi_$corticalregion-autotrack.tt.gz, the structural connection in template space
3. $subid.thalamus-$hemi_$HCPMMPregion-autotrack.stat.txt, a file with tract macrostructural and microstructure statistics

** Note, it is highly recommended to use this thalamocortical tractography atlas with the same autotrack parameters validated here for participant-specific tracking. These parameters include `–-otsu_threshold=0.5, –-smoothing=1, -–tolerance=10, -–tip_iteration=0, -–track_voxel_ratio=4, -–check_ending=0, and -–yield_rate=0.0000001`. Small modifications to these parameters may be beneficial/appropriate depending on the dataset, but should be validated via testing. Furthermore, modifying the tolerance parameter may be reasonable to delineate even stricter trajectory-based pathways (lower the tolerance threshold) or to allow for potential greater individual-specific differences in anatomy to emerge (increase the tolerance).

### Software Notes
Software dependencies:
* Direct download of DSI Studio: none
* DSI Studio container: docker, singularity/apptainer

The thalamocortical atlas has been tested with:
* Direct download 2023.12.06 "Chen" Release on Mac, Direct download 2024.05.22 "Chen" Release on Mac 
* Docker container versions dsistudio/dsistudio:chen-2023-02-27 and dsistudio/dsistudio:chen-2024-06-12. Compatibility in intermediate versions is assumed. Compatability with pre-release versions of Hou is under testing as Hou is being updated frequently.

Typical install time
* Direct download of DSI Studio: minutes
* DSI Studio container build: ~10 min to 1 hour, depending on computing resources



