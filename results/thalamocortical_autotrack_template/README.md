# DIFFUSION MRI ATLAS OF REGIONALLY-SPECIFIC THALAMOCORTICAL STRUCTURAL CONNECTIONS: IMPLEMENTATION INSTRUCTIONS
Instructions for applying the **thalamocortical tractography atlas** are provided below. This atlas can be used with DSI Studio to delineate structural connections between the left and right thalamus and specific cortical regions defined by the HCP-MMP (Glasser) atlas. 

### Step 1. Reconstruct your pre-processed diffusion data with GQI to create FIB files for tracking in DSI Studio
DSI Studio uses FIB files (*fib.gz) reconstructed with generalized q-sampling imaging as input to tractography. FIB files can be reconstructed with dsi studio directly ([see instructions](https://dsi-studio.labsolver.org/doc/cli_t2.html)) or using QSIRecon's *dsi_studio_gqi* workflow. [QSIRecon](https://qsirecon.readthedocs.io/en/latest/) can first be [installed via container](https://qsirecon.readthedocs.io/en/latest/installation.html). Once installed, the built-in reconstruction workflow [dsi_studio_gqi](https://qsirecon.readthedocs.io/en/latest/builtin_workflows.html#dsi-studio-gqi) can be run to generate a *space-T1w*_dwimap.fib.gz file to use with autotrack and the thalamocortical tractography atlas. Note, QSIprep outputs will work as inputs for QSIRecon as-is. 

Example code for QSIRecon:

```bash
singularity run \
    --containall \
    --writable-tmpfs \
    -B "${PWD}" \ #directories to bind in the container
    qsirecon-latest.sif \ #singularity container
    "${PWD}/inputs/qsiprep" \ #input to dsi_studio_gqi, generated by qsiprep
    "${PWD}/results/qsirecon" \ #outputs from dsi_studio_gsi, generated by qsirecon
    participant \ 
    -w "${PWD}/work" \ #work dir
    --nthreads 8 \
    --omp-nthreads 8 \
    --recon-spec dsi_studio_gqi \
    -v -v
``` 

### Step 2. Install DSI Studio
DSI Studio can be obtained directly on Mac, Windows, or Ubuntu via the download links provided here: https://dsi-studio.labsolver.org/download.html. Alternatively, a dsi-studio container can be built via Docker/singularity. The docker hub repository (https://hub.docker.com/r/dsistudio/dsistudio) has all releases of DSI Studio. A container can be built with singularity (or apptainer) as such:

```
singularity dsistudio-latest.simg docker://dsistudio/dsistudio:latest
```

A copy of the container used in "A sensorimotor-association axis of thalamocortical connection development" is provided here.

### Step 3. Access the thalamocortical tractography atlas
In order to utilize the thalamocortical tractography atlas to delineate person-specific thalamic connectivity, two key files, provided [on this page](https://github.com/PennLINC/thalamocortical_development/tree/main/results/thalamocortical_autotrack_template), are needed: 1. ICBM152_adult.tt.gz (template thalamocortical connections, i.e., autotrack tracts) and 2. ICBM152_adult.tt.gz.txt (connection list). In addition, these files must be located within the DSI Studio software in the expected location. 

* On a Mac, this location is dsi_studio/dsi_studio.app/Contents/MacOs/atlas/ICBM152_adult. The files must retain the names used here. So as to not overwrite the original set of autotrack bundles released with DSI Studio, you may rename the original files before copying these thalamocortical files to this location.

* In a container, this location is /opt/dsi-studio/atlas/ICBM152_adult. To use these 2 files with a dsi-studio container, bind a local directory containing the usual contents of atlas/ICBM152_adult (i.e., those provided with the software) PLUS these thalamus-specific .tt.gz and .tt.gz.txt files to the container directory (e.g., -B /cbica/projects/thalamocortical_development/software/thalamocortical_autotrack_template/dsi-studio/atlas/ICBM152_adult/:/opt/dsi-studio/atlas/ICBM152_adult). Or, bind the individual thalamus-specific .tt.gz and .tt.gz.txt files to their corresponding original files in /opt/dsi-studio/atlas/ICBM152_adult.

### Step 4. Run autotrack with the thalamocortical tractography atlas
The population-level thalamocortical tractography atlas can now be used as an anatomical prior to delineate the same connections in individual participants' data. This process involves using DSI Studio's autotrack, a trajectory-based automated tract recognition approach.  

* Instructions for running autotrack in DSI Studio via the command line are provided [here](https://dsi-studio.labsolver.org/doc/cli_atk.html). To track all possible thalamocortical connections, you can run

```bash
dsi_studio --action=atk --source=*.fib.gz --track_id=thalamus
``` 
* Alternatively, to use a DSI Studio container, you can use:

```bash
for TCtract in dsi-studio/atlas/ICBM152_adult/ICBM152_adult.tt.gz.txt; do

     singularity exec --cleanenv --containall \ 
     -B ${DATA_DIR} \ #bind data directory with fib.gz files
     -B dsi-studio/atlas/ICBM152_adult/:/opt/dsi-studio/atlas/ICBM152_adult #bind ICBM152_adult with the two key thalamocortical tractography atlas files from above
     dsistudio-latest.simg \ #dsi studio container 
     dsi_studio \
        --action=atk \ #autotrack
        --source=${LOCAL_FIB} \ #participants fib file, must be accessible in bound $DATA_DIR
	--otsu_threshold=0.5 \
	--smoothing=1 \
	--tolerance=10 \
	--tip_iteration=0 \
	--track_voxel_ratio=4 \
        --check_ending=0 \
        --track_id=$TCtract \
	--export_stat=1 \
	--export_trk=1 \
	--yield_rate=0.0000001 \
	--export_template_trk=1 \
	--overwrite=1 \
done
```

This will generate .tt.gz tractography files for individual thalamocortical connections, with the connection name indicated in the data file, e.g. $sub-idthalamus-R_V1-autotrack.tt.gz

** It is recommended that you use this thalamocortical tractography atlas with the same autotrack parameters validated here for participant-specific data. These parameters include –otsu_threshold=0.5, –smoothing=1, –tolerance=10, –tip_iteration=0, –track_voxel_ratio=4, –check_ending=0, and (for command line usage) –yield_rate=0.0000001. Modifying the tolerance parameter may be reasonable to delineate even stricter trajectory-based pathways (lower the tolerance) or to allow for potential greater individual-specific differences in anatomy to emerge (increase the threshold).

